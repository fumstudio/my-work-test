<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login Page</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Basic styles for the modal */
    #image-modal, #alert-modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
      padding-top: 60px;
      z-index: 3;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      z-index: 3;

    }
    #alert-content {
      background-color: blue;
      color: white;
      padding: 20px;
      border-radius: 5px;
    }
    .img-option {
      cursor: pointer;
      margin: 5px;
      width: 50px;
      height: 50px;
    }
    .profile-photo-container {
      position: relative;
      width: 100px;
      height: 100px;
    }
    .profile-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      z-index: 1;
    }
    .profile-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      z-index: 2;
    }
  </style>
</head>
<body>
  <h1>Login / Signup</h1>

  <div id="user-info">
    <div id="user-details"></div>
  </div>
  <div class="profile-photo-container">
    <img id="default-background" src="https://firebasestorage.googleapis.com/v0/b/myhost-a7ee9.appspot.com/o/images%2FWhatsApp%20Image%202024-09-26%20at%207.51.40%20AM.jpeg?alt=media&token=42565b33-c522-4167-bbd6-3a7f267d6627" alt="Default Background" class="profile-background">
    <img id="user-photo" src="" alt="User Profile Picture" class="profile-image"> 
  </div>
  <div>
    <input type="text" id="first-name" placeholder="First Name">
    <input type="text" id="last-name" placeholder="Last Name">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">

    <div class="profile-photo-container">
      <img id="selected-photo" src="" alt="Selected Photo" width="50" height="50">
      <button id="change-photo-btn">Change Photo</button>
      <input type="file" id="upload-photo" accept="image/*">
    </div>

    <button id="signup-btn">Sign Up</button>
    <button id="login-btn">Login</button>
    <button id="update-profile">Update Profile</button>
    <button id="logout-btn" style="display: none;">Logout</button> 
  </div>

  <!-- Modal for changing photos -->
  <div id="image-modal">
    <div class="modal-content">
      <span id="close-modal" style="cursor:pointer;">&times;</span>
      <h2>Select a Photo</h2>
      <div id="image-options">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRDiBfglDE0DpVdbwpBp6_H01S07njGKHku0A&s" class="img-option" onclick="selectPhoto('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRDiBfglDE0DpVdbwpBp6_H01S07njGKHku0A&s')">
        <img src="photo2.jpg" class="img-option" onclick="selectPhoto('photo2.jpg')">
        <img src="photo3.jpg" class="img-option" onclick="selectPhoto('photo3.jpg')">
      </div>
    </div>
  </div>

  <!-- Custom alert modal -->
  <div id="alert-modal">
    <div class="modal-content">
      <div id="alert-content">This is a custom alert!</div>
      <button id="close-alert">OK</button>
    </div>
  </div>
<a href="comments.html">Go to Comments</a>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getDatabase, ref as dbRef, set, get } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js';

       const firebaseConfig = {
    apiKey: "AIzaSyBDrzrgLslaJvnXbo1e90irCEtdcm9ZsCU",
    authDomain: "logins-13661.firebaseapp.com",
    projectId: "logins-13661",
    storageBucket: "logins-13661.appspot.com",
    messagingSenderId: "451535349483",
    appId: "1:451535349483:web:d3c9867fd2bffbbdca40ae",
    measurementId: "G-DWP16WX2H7"
  };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const storage = getStorage(app);

    // Handle authentication state
    onAuthStateChanged(auth, user => {
      if (user) {
        loadUserProfile(user.uid);
        document.getElementById("logout-btn").style.display = "block"; // Show logout button
      } else {
        resetUI();
        document.getElementById("logout-btn").style.display = "none"; // Hide logout button
      }
    });

    // Load user profile
    async function loadUserProfile(uid) {
      const userSnapshot = await get(dbRef(database, 'users/' + uid));
      if (userSnapshot.exists()) {
        const userData = userSnapshot.val();
        document.getElementById("user-details").textContent = `Logged in as: ${userData.firstName || 'N/A'} ${userData.lastName || 'N/A'} (${userData.email || 'N/A'})`;
        document.getElementById("first-name").value = userData.firstName || '';
        document.getElementById("last-name").value = userData.lastName || '';

        // Retrieve the user's selected photo from Firebase Storage
        if (userData.photoURL) {
          document.getElementById("user-photo").src = userData.photoURL;
          document.getElementById("selected-photo").src = userData.photoURL;
        } else {
          document.getElementById("user-photo").src = ''; // Reset user photo if no user data
          document.getElementById("selected-photo").src = ''; // Reset selected photo if no user data
        }
      } else {
        document.getElementById("user-photo").src = ''; // Reset user photo if no user data
        document.getElementById("selected-photo").src = ''; // Reset selected photo if no user data
      }
    }

    // Reset UI for logged-out state
    function resetUI() {
      document.getElementById("user-details").textContent = '';
      document.getElementById("first-name").value = '';
      document.getElementById("last-name").value = '';
      document.getElementById("user-photo").src = ''; // Reset to empty on logout
      document.getElementById("selected-photo").src = ''; // Reset selected photo on logout
    }

    // Change photo button click event
    document.getElementById("change-photo-btn").addEventListener("click", () => {
      document.getElementById("image-modal").style.display = "block";
    });

    // Select a photo and update the UI
    window.selectPhoto = function(photo) {
      document.getElementById("selected-photo").src = photo;
      document.getElementById("user-photo").src = photo; // Update displayed user photo
      document.getElementById("image-modal").style.display = "none";
    };

    // Close the image selection modal
    document.getElementById("close-modal").addEventListener("click", () => {
      document.getElementById("image-modal").style.display = "none";
    });

    // Show custom alert
    function showAlert(message) {
      document.getElementById("alert-content").textContent = message;
      document.getElementById("alert-modal").style.display = "block";
    }

    // Close alert modal
    document.getElementById("close-alert").addEventListener("click", () => {
      document.getElementById("alert-modal").style.display = "none";
    });

    // Update Profile button click event
    document.getElementById("update-profile").addEventListener("click", async () => {
      const user = auth.currentUser;
      if (user) {
        const photoToUse = document.getElementById("selected-photo").src;

        // Update the user's profile in the database
        await set(dbRef(database, 'users/' + user.uid), {
          firstName: document.getElementById("first-name").value,
          lastName: document.getElementById("last-name").value,
          email: user.email,
          photoURL: photoToUse
        });

        showAlert('Profile updated successfully!');
        loadUserProfile(user.uid); // Refresh user profile display
      } else {
        showAlert("You must be logged in to update your profile.");
      }
    });

    // Handle file selection for profile photo
    document.getElementById("upload-photo").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          document.getElementById("selected-photo").src = e.target.result; // Display selected image
          document.getElementById("user-photo").src = e.target.result; // Update displayed user photo

          // Upload the image to Firebase Storage
          const user = auth.currentUser;
          const storagePath = `profile_photos/${user.uid}`;
          const blob = dataURLtoBlob(e.target.result);
          const storageReference = storageRef(storage, storagePath);
          await uploadBytes(storageReference, blob);
          const photoURL = await getDownloadURL(storageReference);

          // Update user photoURL in database
          await set(dbRef(database, 'users/' + user.uid), {
            photoURL: photoURL
          });
        };
        reader.readAsDataURL(file);
      }
    });

    // User login
    document.getElementById("login-btn").addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        showAlert("Logged in successfully!");
      } catch (error) {
        if (error.code === 'auth/wrong-password') {
          showAlert("Wrong password. Please try again.");
        } else if (error.code === 'auth/user-not-found') {
          showAlert("Email not registered. Please sign up.");
        } else {
          showAlert("Unrecognized error. Please try again.");
        }
      }
    });

    // User registration
    document.getElementById("signup-btn").addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const firstName = document.getElementById("first-name").value;
      const lastName = document.getElementById("last-name").value;

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        await set(dbRef(database, 'users/' + user.uid), {
          firstName,
          lastName,
          email,
          photoURL: ''
        });
        showAlert("User registered successfully!");
      } catch (error) {
        console.error("Error registering:", error);
        showAlert(error.message);
      }
    });

    // User logout
    document.getElementById("logout-btn").addEventListener("click", async () => {
      await signOut(auth);
      showAlert("Logged out successfully!");
    });

    // Helper function to convert data URL to Blob
    function dataURLtoBlob(dataURL) {
      const parts = dataURL.split(',');
      const mime = parts[0].split(':')[1].split(';')[0];
      const byteString = atob(parts[1]);
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }
      return new Blob([ab], { type: mime });
    }
  </script>
</body>
</html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comments Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      #user-info {
        display: none;
      }
      .profile-photo-container {
        display: flex;
        align-items: center;
        margin-top: 10px;
      }
      #selected-photo {
        border-radius: 50%;
        margin-right: 10px;
      }
      button {
        margin-top: 10px;
      }
      body { 
  font-family: Arial, sans-serif;
  background-color: #f4f4f4;
  color: #333;
  margin: 0;
  padding: 20px;
}

/* User Info */
#user-info {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
}

#user-photo {
  border-radius: 50%;
  margin-right: 10px;
  width: 40px;
  height: 40px;
}

input[type="text"],
input[type="email"],
input[type="password"],
textarea {
  width: calc(80% - 20px);
  padding: 10px;
  margin: 10px 0;
  border: 1px solid #ccc;
  border-radius: 5px;
}

/* Profile Photo Upload */
.profile-photo-container {
  display: flex;
  align-items: center;
  margin: 10px 0;
}

#selected-photo {
  border-radius: 50%;
  margin-right: 10px;
  width: 40px;
  height: 40px;
}

.remove-photo-btn {
  background: transparent;
  border: none;
  color: red;
  cursor: pointer;
  font-size: 20px;
}

/* Button Icon Styles */
.button-icon {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  margin-left: 8px;
  color: #888;
  font-size: 14px;
}

.button-icon:hover {
  color: #333;
}

/* Buttons */
button {
  background-color: #5c6bc0;
  color: white;
  border: none;
  padding: 10px 10px;
  border-radius: 5px;
  cursor: pointer;
  margin: 5px 0;
}

button:hover {
  background-color: #3949ab;
}

/* Comment Section */
#comment-section {
  margin-top: 20px;
  background: #fff;
  padding: 15px;
  border-radius: 5px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

#comments {
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 10px;
}

/* Comment Styles */

.comment img {
  border-radius: 50%;
  margin-right: 10px;
  width: 30px;
  height: 30px;
}

.comment span {
  line-height: 1.5;
  font-size: 14px;
}

/* Replies Styles */
.replies {
  margin-left: 40px;
  padding-top: 10px;
}

.reply {
  display: flex;
  align-items: flex-start;
  padding: 5px 0;
}

.reply img {
  width: 25px;
  height: 25px;
  margin-right: 10px;
}



.gray-background {
  background-color: #f9f9f9;
}

/* Icons */
.user-icon {
  font-size: 20px;
  color: #888;
}

.blue-icon {
  color: #5c6bc0;
}

/* Responsive Styles */
@media (max-width: 600px) {
  #comment-section {
    padding: 10px;
  }

  button {
    padding: 8px 12px;
  }
 .reply-input {
    width: calc(100% - 45px); /* Adjust width for mobile */
  }

  #user-info {
    flex-direction: column; /* Stack user info on mobile */
    align-items: flex-start;
  }


  #user-photo {
    width: 30px;
    height: 30px;
  }
}

@media (min-width: 601px) {
  /* Desktop Styles */
  #comment-section {
    width: 600px; /* Fixed width for desktop */
    margin: 0 auto; /* Center the comment section */
  }

  .reply-input {
    width: calc(100% - 70px); /* Adjust width for desktop */
  }
}
 #user-info {
      display: none;
      margin-bottom: 20px;
    }
    .profile-photo-container {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    #user-photo, #selected-photo {
      width: 100px; /* Fixed width for the image */
      height: 100px; /* Fixed height for the image */
      border-radius: 50%; /* Make the image round */
      object-fit: cover; /* Crop the image to fill the circle */
      margin-right: 10px; /* Space between image and file input */
    }
    #user-details {
      margin-top: 10px;
    }
    button {
      margin-top: 10px;
    }


.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    background-color: rgba(0, 0, 0, 0.5); /* Black background with opacity */
}

.modal-content {
    background-color: white;
    margin: 15% auto; /* 15% from the top and centered */
    padding: 20px;
    border: 1px solid #888;
    width: 80%; /* Could be more or less, depending on screen size */
}

.button {
    padding: 10px 20px;
    margin: 5px;
    border: none;
    cursor: pointer;
}

.yes {
    background-color: blue;
    color: white;
}

.no {
    background-color: gray;
    color: white;
}

        img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="confirmModal" class="modal">
    <div class="modal-content">
        <p>Are you sure you want to delete this comment?</p>
        <button id="yesButton" class="button yes">Yes</button>
        <button id="noButton" class="button no">No</button>
    </div>
</div>
<div id="reply-confirmation-modal" class="modal"> <!-- Updated ID -->
    <div class="modal-content">
        <p id="reply-modal-message">Are you sure you want to delete this reply?</p> <!-- Updated ID -->
        <button id="reply-yes-button" class="button yes">Yes</button> <!-- Updated ID -->
        <button id="reply-no-button" class="button no">No</button> <!-- Updated ID -->
    </div>
</div>


<div id="comment-count">Total Comments: 0</div>
<div id="comments"></div>

    <h1>Comments Section</h1>
    <div id="user-info"></div>
    <img id="user-photo" src="" alt="User Photo">
    <div>
        <input type="text" id="comment-input" placeholder="Write your comment...">
        <button id="submit-comment">Submit Comment</button>
    </div>
    <div id="comments"></div>
<a href="login.html">Go to Comments</a>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getDatabase, ref as dbRef, onValue, set, get, remove } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

           const firebaseConfig = {
    apiKey: "AIzaSyBDrzrgLslaJvnXbo1e90irCEtdcm9ZsCU",
    authDomain: "logins-13661.firebaseapp.com",
    projectId: "logins-13661",
    storageBucket: "logins-13661.appspot.com",
    messagingSenderId: "451535349483",
    appId: "1:451535349483:web:d3c9867fd2bffbbdca40ae",
    measurementId: "G-DWP16WX2H7"
  };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const pageId = "page3";

        onAuthStateChanged(auth, user => {
            if (user) {
                const uid = user.uid;
                loadUserProfile(uid);
                loadComments();
            } else {
                document.getElementById("user-info").textContent = "Not logged in.";
                document.getElementById("comments").innerHTML = "";
            }
        });

        async function loadUserProfile(uid) {
            const userSnapshot = await get(dbRef(database, 'users/' + uid));
            if (userSnapshot.exists()) {
                const userData = userSnapshot.val();
                document.getElementById("user-info").textContent = `Logged in as: ${userData.firstName} ${userData.lastName} (${userData.email})`;
                document.getElementById("user-photo").src = userData.photoURL || '';
            }
        }

       function loadComments() {
    const commentsRef = dbRef(database, 'comments/' + pageId);
    onValue(commentsRef, (snapshot) => {
        const commentsDiv = document.getElementById("comments");
        commentsDiv.innerHTML = ""; // Clear the commentsDiv

        let commentCount = 0; // Initialize comment counter

        snapshot.forEach((childSnapshot) => {
            const commentData = childSnapshot.val();
            const commentElement = document.createElement("div");
            commentElement.className = "comment";
            commentElement.id = 'comment-' + childSnapshot.key; // Add ID to the comment element

            const img = document.createElement("img");
            img.src = commentData.photoURL || '';
            img.alt = `${commentData.firstName} ${commentData.lastName}'s photo`;
            img.onerror = () => {
                img.src = "https://za.rapid.studio/ocache/821/resources/themes/kh-preview-05.webp?size=1320&t=1735689600";
            };
            commentElement.appendChild(img);

            const textElement = document.createElement("span");
            textElement.textContent = `${commentData.firstName} ${commentData.lastName}: ${commentData.text}`;
            commentElement.appendChild(textElement);

            const user = auth.currentUser;
            if (user) {
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";

                // Show delete button if the current user is the comment author
                if (user && commentData.user === user.email) {
                    deleteButton.onclick = () => deleteComment(childSnapshot.key); // Pass commentData
                    commentElement.appendChild(deleteButton);
                }

                const editButton = document.createElement("button");
                editButton.textContent = "Edit Comment";
                if (user && commentData.user === user.email) {
                    editButton.onclick = () => editComment(childSnapshot.key, commentData);
                    commentElement.appendChild(editButton);
                }
            }

            // Add the comment to the top of the list
            commentsDiv.prepend(commentElement);
            commentCount++; // Increment comment counter
        });

        // Update the comment count display
        document.getElementById("comment-count").textContent = `Total Comments: ${commentCount}`;
    });
}

        function loadReplies(commentId, repliesElement, commentData) {
            const repliesRef = dbRef(database, 'comments/' + commentId + '/replies');
            onValue(repliesRef, (snapshot) => {
                repliesElement.innerHTML = '';
                snapshot.forEach(childSnapshot => {
                    const replyData = childSnapshot.val();
                    const replyElement = document.createElement("div");
                    replyElement.className = "reply";

                    const img = document.createElement("img");
                    img.src = replyData.photoURL || '';
                    img.alt = `${replyData.firstName} ${replyData.lastName}'s photo`;
                    img.onerror = () => {
                        img.src = "https://za.rapid.studio/ocache/821/resources/themes/kh-preview-05.webp?size=1320&t=1735689600";
                    };
                    replyElement.appendChild(img);

                    const textElement = document.createElement("span");
                    textElement.textContent = `${replyData.firstName} ${replyData.lastName}: ${replyData.text}`;
                    replyElement.appendChild(textElement);

                    const user = auth.currentUser;
                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "Delete";

                    // Show delete button if the current user is the reply author or the original commenter
                    if (user && (replyData.user === user.email || commentData.user === user.email)) {
                        deleteButton.onclick = () => deleteReply(commentId, childSnapshot.key, commentData); // Pass commentData
                        replyElement.appendChild(deleteButton);
                    }

                    const editButton = document.createElement("button");
                    editButton.textContent = "Edit Reply";
                    if (user && replyData.user === user.email) {
                        editButton.onclick = () => editReply(commentId, childSnapshot.key, replyData);
                        replyElement.appendChild(editButton);
                    }

                    repliesElement.appendChild(replyElement);
                });
            });
        }

        function submitReply(commentId, replyInput) {
            const replyText = replyInput.value;
            const user = auth.currentUser;

            if (replyText && user) {
                const userSnapshot = get(dbRef(database, 'users/' + user.uid));
                userSnapshot.then(async snapshot => {
                    const { firstName, lastName, photoURL } = snapshot.val();
                    const replyRef = dbRef(database, 'comments/' + commentId + '/replies/' + Date.now());
                    set(replyRef, {
                        text: replyText,
                        user: user.email,
                        firstName: firstName || 'Anonymous',
                        lastName: lastName || '',
                        photoURL: photoURL || '',
                    });
                    replyInput.value = ''; 
                });
            }
        }
  async function deleteReply(commentId, replyId, commentData) {
    const user = auth.currentUser;
    if (user) {
        const replyRef = dbRef(database, 'comments/' + commentId + '/replies/' + replyId);
        const replyData = await get(replyRef);

        if (replyData.exists() && (replyData.val().user === user.email || commentData.user === user.email)) {
            // Update the modal message to ask about deleting the reply
            const modalMessage = document.getElementById('reply-modal-message');
            modalMessage.textContent = "Do you want to delete this reply?"; // Updated message

            // Show the modal
            const modal = document.getElementById('reply-confirmation-modal'); // Updated ID
            modal.style.display = 'block';

            return new Promise((resolve) => {
                document.getElementById('reply-yes-button').onclick = async () => {
                    await set(replyRef, null);
                    modal.style.display = 'none';
                    resolve(true);
                };

                document.getElementById('reply-no-button').onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
            });
        }
    }
}

// To close the modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('reply-confirmation-modal'); // Updated ID
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};


        document.getElementById("submit-comment").addEventListener("click", async () => {
            const commentInput = document.getElementById("comment-input");
            const commentText = commentInput.value;
            const user = auth.currentUser;

            if (commentText && user) {
                const userSnapshot = await get(dbRef(database, 'users/' + user.uid));
                const { firstName, lastName, photoURL } = userSnapshot.val();

                const commentRef = dbRef(database, 'comments/' + pageId + '/' + Date.now());
                await set(commentRef, {
                    text: commentText,
                    user: user.email,
                    firstName: firstName || 'Anonymous',
                    lastName: lastName || '',
                    photoURL: photoURL || '',
                });
                commentInput.value = ""; // Clear input
            } else {
                alert("You must be logged in to submit a comment.");
            }
        });

        function editComment(commentId, commentData) {
            const newText = prompt("Edit your comment:", commentData.text);
            if (newText) {
                const commentRef = dbRef(database, 'comments/' + pageId + '/' + commentId);
                set(commentRef, {
                    ...commentData,
                    text: newText,
                });
            }
        }
async function deleteComment(commentId) {
    const user = auth.currentUser;
    if (user) {
        const commentRef = dbRef(database, 'comments/' + pageId + '/' + commentId);

        // Show the modal
        const modal = document.getElementById('confirmModal');
        modal.style.display = 'block';

        return new Promise((resolve) => {
            document.getElementById('yesButton').onclick = async () => {
                await remove(commentRef);
                modal.style.display = 'none';
                resolve(true);
            };

            document.getElementById('noButton').onclick = () => {
                modal.style.display = 'none';
                resolve(false);
            };
        });
    }
}

// To close the modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('confirmModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};


// To close the modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('confirmModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};


        function editReply(commentId, replyId, replyData) {
            const newText = prompt("Edit your reply:", replyData.text);
            if (newText) {
                const replyRef = dbRef(database, 'comments/' + commentId + '/replies/' + replyId);
                set(replyRef, {
                    ...replyData,
                    text: newText,
                });
            }
        }

        async function updateUserComments(email, firstName, lastName, photoURL) {
            const commentsRef = dbRef(database, 'comments/' + pageId);
            const snapshot = await get(commentsRef);
            snapshot.forEach(childSnapshot => {
                const commentId = childSnapshot.key;
                const commentData = childSnapshot.val();
                if (commentData.user === email) {
                    set(dbRef(database, 'comments/' + pageId + '/' + commentId), {
                        ...commentData,
                        firstName: firstName,
                        lastName: lastName,
                        photoURL: photoURL
                    });
                }

                const repliesRef = dbRef(database, 'comments/' + pageId + '/' + commentId + '/replies/');
                get(repliesRef).then(repliesSnapshot => {
                    repliesSnapshot.forEach(replySnapshot => {
                        const replyData = replySnapshot.val();
                        if (replyData.user === email) {
                            set(dbRef(database, 'comments/' + pageId + '/' + commentId + '/replies/' + replySnapshot.key), {
                                ...replyData,
                                firstName: firstName,
                                lastName: lastName,
                                photoURL: photoURL
                            });
                        }
                    });
                });
            });
        }

        // Function to update user info in existing comments and replies
        async function updateUserInfoInComments(email, firstName, lastName, photoURL) {
            const commentsRef = dbRef(database, 'comments/' + pageId);
            const snapshot = await get(commentsRef);
            snapshot.forEach(childSnapshot => {
                const commentId = childSnapshot.key;
                const commentData = childSnapshot.val();
                if (commentData.user === email) {
                    // Update the comment itself
                    const commentElement = document.getElementById('comment-' + commentId);
                    if (commentElement) { // Check if the comment element exists
                        const img = commentElement.querySelector('img');
                        if (img) {
                            img.src = photoURL || '';
                            img.alt = `${firstName} ${lastName}'s photo`;
                        }
                        const textElement = commentElement.querySelector('span');
                        if (textElement) {
                            textElement.textContent = `${firstName} ${lastName}: ${commentData.text}`;
                        }
                    }
                }

                // Update replies within the comment
                const repliesElement = document.getElementById('replies-' + commentId);
                if (repliesElement) {
                    const replyElements = repliesElement.querySelectorAll('.reply');
                    replyElements.forEach(replyElement => {
                        const replyData = replyElement.querySelector('span').textContent.split(': ')[0];
                        const [replyFirstName, replyLastName] = replyData.split(' ');
                        if (replyFirstName === firstName && replyLastName === lastName) {
                            const img = replyElement.querySelector('img');
                            if (img) {
                                img.src = photoURL || '';
                                img.alt = `${firstName} ${lastName}'s photo`;
                            }
                            const textElement = replyElement.querySelector('span');
                            if (textElement) {
                                textElement.textContent = `${firstName} ${lastName}: ${replyElement.querySelector('span').textContent.split(': ')[1]}`;
                            }
                        }
                    });
                }
            });
        }

        document.getElementById("update-profile").addEventListener("click", async () => {
            const user = auth.currentUser;
            if (user) {
                const selectedPhoto = document.getElementById("selected-photo").src;
                const firstName = document.getElementById("first-name").value;
                const lastName = document.getElementById("last-name").value;

                // Update the user's profile in the database
                await set(dbRef(database, 'users/' + user.uid), {
                    firstName: firstName,
                    lastName: lastName,
                    email: user.email,
                    photoURL: selectedPhoto || user.photoURL 
                });

                // Refresh the user profile display
                loadUserProfile(user.uid); 

                // Update comments and replies with the new profile data
                const updatedPhotoURL = selectedPhoto || user.photoURL;
                await updateUserComments(user.email, firstName, lastName, updatedPhotoURL);

                // Update user info in existing comments and replies
                await updateUserInfoInComments(
                    user.email, 
                    firstName, 
                    lastName, 
                    updatedPhotoURL
                );

            } else {
                alert("You must be logged in to update your profile.");
            }
        });
    </script>
</body>
</html>
  
